function e(e){return"string"==typeof e}function t(e){return"[object Object]"===Object.prototype.toString.call(e)}function n(e){return Array.isArray(e)}function s(e){return void 0===e}function r(e){return!!e&&!!e.nodeName&&"#text"===e.nodeName}function o(){return"undefined"!=typeof document}function i(e){const s=n(e)?[]:{};let r;for(let o in e)r=e[o],t(r)||n(r)?s[o]=i(r):s[o]=r;return s}class a extends Error{constructor(e){super("[ Encre-Error ] - "+e)}}function l(e=""){throw new a(e)}function c(e){return e[e.length-1]}var u,h,d,g;(h=u||(u={})).CONTAINER="container",h.EDITOR="editor",h.EDITOR_BLOCK="block",h.EDITOR_ZONE="zone",(g=d||(d={}))[g.INLINE=1]="INLINE",g[g.BLOCK=2]="BLOCK";const p={editor:"encre-editor",block:"encre-block",inline:"encre-inline",focus:"focused",paragraph:"encre-paragraph"};class m{constructor(e,t={}){this.classes=Object.assign({},p,t),this.editable=!e.opts.readonly}createEditorElement(e={},t=[]){return x("div",{class:this.classes.editor+"__container"},[x("div",A({class:""+this.classes.editor,role:u.EDITOR,spellcheck:!1,tabindex:-1},e),t)])}createTemplateBlock(...e){let t;t=s(e[0])||e[0]instanceof Node?[]:e[0];const n=x("div",{class:""+this.classes.block,role:u.EDITOR_BLOCK},[x("div",{class:this.classes.block+"__content"},t)]);if(e[0]instanceof Node){const t=_(n);return $.getLastRightElement(t).append(e[0]),t}return n}createParagraph(e=[]){const t=this.editable?{contenteditable:"true"}:{};return x("p",A({class:this.classes.paragraph,role:u.EDITOR_ZONE},t),e)}}class f{constructor(e,t,n=""){this.type=2,this.$cursor=e.$cursor,this.$elements=e.$elements,this.$event=e.$event,this.bindDOMFunction=t,this.activateClass=n}bind(){let t;if(this.bindDOMFunction&&(t=this.bindDOMFunction.call(null))){if(e(t)&&(t=$.seletor(t)),!t)return;const n=this;t.addEventListener("click",n.exec.bind(n),!1),this.$cursor.registerOnRangeCallbacks((()=>{t&&!e(t)&&(n.isActivated()?t.classList.add(n.activateClass):t.classList.contains(n.activateClass)&&t.classList.remove(n.activateClass))}))}}exec(...e){}onEnter(){return!1}isActivated(){return!1}}var C,E;(E=C||(C={}))[E.FRAGMENT=1]="FRAGMENT",E[E.NODES=2]="NODES",E[E.TEXT=4]="TEXT",E[E.BLOCK=8]="BLOCK";const b="No Document Specified",$={createElement:e=>(o()||l(b),document.createElement(e)),createTextNode(e){o()||l(b);const t=document.createTextNode(e);return t._in_encre=!0,t},createFragment:()=>(o()||l(b),document.createDocumentFragment()),seletor:e=>(o()||l(b),document.querySelector(e)),get selection(){return o()||l(b),window.getSelection()},get range(){let e;return(e=$.selection)&&e.rangeCount?e.getRangeAt(0):null},createRange:()=>(o()||l(b),document.createRange()),execCommand:(e,t)=>(o()||l(b),document.queryCommandSupported(e)&&document.execCommand(e,!1,t)),checkCommandState:e=>(o()||l(b),document.queryCommandState(e)),getFirstLeftNode(e){if(!e.firstChild)return e;let t=e.firstChild;for(;t&&t.firstChild;)t=t.firstChild;return t},getLastRightNode(e){if(!e.lastChild)return e;let t=e.lastChild;for(;t&&t.lastChild;)t=t.lastChild;return t},getLastRightElement(e){if(!e.lastElementChild)return e;let t=e.lastElementChild;for(;t&&t.lastElementChild;)t=t.lastElementChild;return t},setLastRightElement(e,t){let n=e;for(;n.children.length>0;)if(!(n=n.lastElementChild))return;n.appendChild(t)},setCursor(e,t){const n=$.createRange(),s=$.selection;if(s)return n.setStart(e,t),n.setEnd(e,t),n.collapse(),s.removeAllRanges(),s.addRange(n),n},get isCursoring(){return"Caret"===$.selection?.type},get isOnRange(){return"Range"===$.selection?.type},traverseAndFind(e,t=(()=>!0)){const n=[e];let s;for(;n.length>0;){if(s=n.shift(),t.call(null,s))return s;for(let e=0;e<s.children.length;e++)n.push(s.children[e])}},createGetParentTemplate(e,t=((...e)=>!1)){let n=e.parentElement;for(;n&&!t.call(null,n);)n=n.parentElement;return n},get spaceUnicode(){return" "}};function v(e){return!!e._is_abstract}function R(t){return e(t)?N(t):t}function O(t){if(n(t)){const e=[];for(let n=0;n<t.length;n++)e.push(R(t[n]));return e}return e(t)?[N(t)]:[t]}function N(e){return{tag:"",props:{},children:e,_is_abstract:!0,type:4}}function y(e,t,n){return{tag:e,props:t,children:O(n),_is_abstract:!0,type:2}}function k(e){return{tag:"",props:{},children:O(e),type:1,_is_abstract:!0}}function T(n,s){s._in_encre=!0;for(let r in n)switch(r){case"class":case"style":{const o=n[r];if(e(o))"class"===r?s.className=o:"style"===r&&s.setAttribute("style",o);else if(t(o)){const e=[];for(let t in o)"style"===r?s.style.setProperty(t.replace(/\B([A-Z])/g,"-$1").toLowerCase(),o[t]):"class"===r&&o[t]&&e.push(t);e.length>0&&(s.className=e.join(" "))}break}default:if(r.match(/on([A-Z].*)/)){const e=RegExp.$1.toLowerCase();s.addEventListener(e,n[r],!1)}else s.setAttribute(r,String(n[r]))}}function L(e){if(1===e.type)return $.createFragment();let t;return 4===e.type?t=$.createTextNode(String(e.children)):(t=$.createElement(e.tag),T(e.props,t)),t}function _(e){const t=[e],n=[];let s,r,o,i;for(;t.length>0;){if(i=c(n),i&&i.childrenCount--,s=t.pop(),o=L(s),4===s.type||0===s.children.length)!i||i.elm instanceof Text||i.elm.append(o);else{for(let e=s.children.length-1;e>=0;e--)r=R(s.children[e]),t.push(r);n.push({elm:o,childrenCount:s.children.length,rawCount:s.children.length})}for(;n.length>0&&(i=c(n))&&0===i.childrenCount;)o=n.pop().elm,n.length>0&&(i=c(n))&&!(i.elm instanceof Text)&&i.elm.append(o)}return o||document.createDocumentFragment()}function x(...r){let o,i,a={},l=[],c="";if(1===r.length){if(o=r[0],e(o))return y(o,{},[]);if(n(o))return k(o)}else if(r.length>=2){if(o=r[0],i=r[1],!e(o))return k([]);if(c=o,t(i)&&!v(i)?a=i:l=O(i),r.length>=3){let e=r.slice(2);for(let t=0;t<e.length;t++)s(e[t])||(l=l.concat(O(e[t])))}return y(c,a,l)}return k([])}function A(...n){const s={};let r;for(let o of n)for(let n in o)switch(r=o[n],n){case"class":case"style":if(s[n]||(s[n]={}),t(r))for(let e in r)s[n][e]=r[e];else e(r)&&("class"===n?s[n][r]=!0:s[n]+=r);break;default:s[n]=t(r)?i(r):r}return s}const D=["class","style"];class w{constructor(e){this.$editor=e,this.callbacks=[]}registerOnRangeCallbacks(e){e&&this.callbacks.push(e)}execCallbacks(){let e;const t=this;for(let n=0;n<t.callbacks.length;n++)e=t.callbacks[n],e&&e.call(null,t)}get collapsed(){return this.range?.collapsed}get rangeSameNode(){if(this.range)return!this.collapsed&&this.range.startContainer===this.range.endContainer&&this.range.commonAncestorContainer===this.range.startContainer&&this.range.commonAncestorContainer===this.range.endContainer}initRange(e){const t=$.getLastRightNode(e),n=t.textContent?.length||0;t&&!s(n)&&(this.range=$.setCursor(t,n),this.saveCursoredElm())}saveRange(e){if(e)return void(this.range=e);let t;(t=$.range)&&(this.range=t)}saveCursoredElm(){if(!this.range)return;let e;var t;t=this.range.startContainer,(e=$.createGetParentTemplate(t,(e=>e.getAttribute("role")===u.EDITOR_BLOCK)))&&this.cursoredElm!==e&&(this.cursoredElm&&this.cursoredElm.classList.remove(this.$editor.focusClassName),this.cursoredElm=e,this.cursoredElm.classList.add(this.$editor.focusClassName)),this.execCallbacks()}}const I={tabWidth:2};class S{constructor(e,t={}){this.isComposing=!1,this.$editor=e,this.$cursor=this.$editor.$cursor,this.$elements=this.$editor.$elements,this.$tools=this.$editor.tools,this.opts=Object.assign({},I,t)}onAfterUpdate(){this.$cursor.saveCursoredElm()}onBeforeUpdate(){const e=$.selection;let t,n;$.isCursoring?e&&(t=e.anchorNode)&&(n=e.anchorOffset,this.$cursor.saveRange($.setCursor(t,n))):this.$cursor.saveRange()}onCompositionstart(e){this.onBeforeUpdate(),this.isComposing=!0}onCompositionend(){this.isComposing=!1,this.onAfterUpdate()}onInput(){this.isComposing}onMousedown(){}onMouseup(){this.onBeforeUpdate(),this.onAfterUpdate()}_onTab(){if(!this.$cursor.range)return;const{startContainer:e,startOffset:t,endContainer:n,endOffset:s}=this.$cursor.range;if(!r(e)||!r(n))return;const o=this.opts.tabWidth||I.tabWidth,i=$.spaceUnicode.repeat(o);this.$cursor.rangeSameNode?e.replaceData(t,s-t,i):(this.$cursor.collapsed||this.$cursor.range.deleteContents(),e.insertData(t,i));const a=$.setCursor(e,t+o);this.$cursor.saveRange(a)}insertNewParagraph(e){let t,n;if(!(t=this.$editor.elm)||!(n=this.$cursor.cursoredElm))return;const s=_(this.$elements.createTemplateBlock(this.$elements.createParagraph()));let r;$.setLastRightElement(s,e),(r=n.nextElementSibling)?t.insertBefore(s,r):t.appendChild(s),this.$cursor.saveRange($.setCursor($.getFirstLeftNode(s),0)),this.$cursor.saveCursoredElm()}copyRawContents(){let e;if(!this.$cursor.range||!(e=this.$cursor.cursoredElm))return;const{startContainer:t,startOffset:n,endContainer:s}=this.$cursor.range,r=$.createRange();if(this.$cursor.collapsed||this.$cursor.range.deleteContents(),!s.parentElement)return;const o=$.getLastRightNode(s.parentElement);r.setStart(t,n),r.setEnd(o,o.textContent?.length||0);return{cloneContents:r.cloneContents(),newRange:r}}_onEnter(){const e=this.copyRawContents();if(s(e))return;const{cloneContents:t,newRange:n}=e;let r,o;for(let e=0;e<this.$tools.length;e++)if(r=this.$tools[e],r.type===d.BLOCK&&(o=!!r.onEnter(t,n),o))return;this.insertNewParagraph(t),n.deleteContents()}_onBackspace(){let e,t,n,s;(t=this.$editor.elm)&&(e=this.$cursor.cursoredElm)&&!e.textContent&&(t.children.length>1?(n=e.previousElementSibling,t.removeChild(e)):n=e,n&&(s=$.getLastRightNode(n))&&r(s)&&(this.$cursor.saveRange($.setCursor(s,s.data.length)),this.$cursor.saveCursoredElm()))}onKeydown(e){if(!this.isComposing)switch(this.onBeforeUpdate(),e.key){case"Enter":e.preventDefault(),this._onEnter();break;case"Tab":e.preventDefault(),this._onTab();break;case"Backspace":this._onBackspace();break;default:this.$cursor.saveRange()}}onKeyup(e){this.onAfterUpdate()}}const B={placeholder:"Please input something!!",autofocus:!0,readonly:!1,classes:p};class F{constructor(e={}){this.tools=[],this.opts=Object.assign({},B,e),this.$elements=new m(this,e.classes),this.$cursor=new w(this),this.$event=new S(this),this.editor=this._createEditor()}get focusClassName(){return this.$elements.classes.focus}mount(e){const t=_(this.editor);return this.elm=$.traverseAndFind(t,(e=>"editor"===e.getAttribute("role"))),e.innerHTML="",e.append(t),this.opts.readonly||(this.opts.autofocus&&this.$cursor.initRange(e),this.tools.forEach((e=>{e.bind()}))),this}_createEditor(){let e={};const t=this;this.opts.readonly||(e={onMousedown:()=>t.$event.onMousedown(),onMouseup:()=>t.$event.onMouseup(),onKeydown:e=>t.$event.onKeydown(e),onKeyup:e=>t.$event.onKeyup(e),onInput:()=>t.$event.onInput(),onCompositionstart:e=>t.$event.onCompositionstart(e),onCompositionend:()=>t.$event.onCompositionend()});const n=this.$elements.createParagraph(this.opts.placeholder);return this.$elements.createEditorElement(e,[this.$elements.createTemplateBlock(n)])}onRangeSaved(e){this.$cursor.registerOnRangeCallbacks(e)}getJson(){let e;if((e=this.elm)&&e.getAttribute("role")===u.EDITOR)return function(e){const t=[],n=[];let s,r;for(e.childElementCount>0&&e.firstElementChild&&t.push(e.firstElementChild);t.length>0&&(s=t.pop())&&(r=$.traverseAndFind(s,(e=>e.getAttribute("role")===u.EDITOR_ZONE)),r);){let e;const o={};for(let t=0;t<r.attributes.length;t++)e=r.attributes[t],D.includes(e.name)&&(o[e.name]=e.value);n.push({tag:r.tagName.toLowerCase(),children:r.innerHTML,props:o,_is_abstract:!1,type:8}),s.nextElementSibling&&t.push(s.nextElementSibling)}return n}(e)}setJson(t){let n;if(!(n=this.elm)||n.getAttribute("role")!==u.EDITOR)return;const s=[];let r,o;for(let n=0;n<t.length;n++)r=t[n],r._is_abstract&&e(r.children)&&8===r.type&&(o=$.createElement(r.tag),r.props.role=u.EDITOR_ZONE,T(r.props,o),this.opts.readonly?o.removeAttribute("contenteditable"):o.setAttribute("contenteditable","true"),o.innerHTML=r.children,s.push(this.$elements.createTemplateBlock(o)));return 0===s.length&&s.push(_(this.$elements.createTemplateBlock(this.$elements.createParagraph()))),n.innerHTML="",n.append(...s),this}register(e){let t,n;const s=this;for(let r=0;r<e.length;r++)n=e[r],t=new n[0](s,...n.slice(1)),this.tools.push(t)}}function M(e,t){return class extends f{constructor(){super(...arguments),this.type=d.INLINE}exec(){let n,s;if(n=this.$cursor.range){if(this.$cursor.collapsed){const{startOffset:e,startContainer:t}=n;s=$.setCursor(t,e)}$.execCommand(e,t),this.$cursor.saveRange(s),this.$cursor.saveCursoredElm()}}isActivated(){return $.checkCommandState(e)}}}const U=M("bold"),K=M("italic"),P=M("underline"),q=M("strikeThrough");let Z=1;function j(e=(()=>null),t=(()=>!1),n=!1){return class extends f{constructor(...n){super(...n),this.makeDOMFunc=e,this.onEnterFunc=t,this.blockUID=Z++}exec(){let e,t;if(!(e=this.$cursor.cursoredElm)||!(t=this.makeDOMFunc.call(null,this)))return;const s=e.lastElementChild,r=function(e){if(!e)return;let t,n;for(let s=0;s<e.children.length;s++)if(t=e.children.item(s),t&&t.getAttribute("role")===u.EDITOR_ZONE){n=t;break}return n}(s);if(!r||!s)return;if(n){if(v(t)){T(A(t.props,this.$elements.editable?{contenteditable:!0}:{},{role:u.EDITOR_ZONE}),r)}return}const o=s.textContent||"";let i=null;v(t)&&(t=_(t)),this.$elements.editable?t.setAttribute("contenteditable","true"):t.removeAttribute("contenteditable"),t.setAttribute("role",u.EDITOR_ZONE),i=$.getLastRightElement(t),i.append(o),this.$cursor.cursoredElm._block_uid=this.blockUID,r?.remove(),s.append(t),this.$cursor.saveRange($.setCursor(i,0)),this.$cursor.saveCursoredElm()}onEnter(...e){const t=this;return!!t.isActivated()&&Boolean(t.onEnterFunc.call(null,t,...e))}isActivated(){return!!this.$cursor.cursoredElm&&this.$cursor.cursoredElm._block_uid===this.blockUID}}}const G=j((e=>e.$elements.createParagraph())),H=j((()=>x("blockquote",{class:"encre-blockquote"}))),J=j((()=>x("h1",{class:"encre-heading-1"})));function W(e="auto"){return j((()=>x("p",{style:{"text-align":e}})),void 0,!0)}const X=W("start"),z=W("center"),Q=W("end");function V(e){const t=e?"ol":"ul",n="li";return j((()=>x(t,{class:"encre-list"},[x(n,{class:"encre-list--item"})])),((e,s,r)=>{let o,i=null;if(!(r&&(o=e.$cursor.range)&&(a=o.endContainer,i=$.createGetParentTemplate(a,(e=>e.tagName===n.toUpperCase())))&&(i.nextElementSibling||s))){let e;return(e=o?.endContainer)&&!e.textContent&&e.parentElement?.removeChild(e),!1}var a;const l=(e=>$.createGetParentTemplate(e,(e=>e.tagName===t.toUpperCase())))(i);if(l){let t;const o=_(x(n,{class:"encre-list--item"}));return s&&o.appendChild(s),(t=i.nextElementSibling)?(!o.textContent&&(o.textContent=$.spaceUnicode),l.insertBefore(o,t)):l.append(o),e.$cursor.saveRange($.setCursor($.getFirstLeftNode(o),0)),e.$cursor.saveCursoredElm(),r.deleteContents(),r.startContainer.textContent||(r.startContainer.textContent=$.spaceUnicode),!0}return!1}))}const Y=V(!0),ee=V();const te=(ne=()=>x("img",{class:"encre-img",style:{"max-width":"100%"}}),class extends f{constructor(...e){super(e[0],(()=>null)),this.type=d.INLINE,this.makeDOMFunc=ne,this.bindImgButtonFunc=e[1]}bind(){this.bindImgButtonFunc&&this.bindImgButtonFunc.call(null,this.exec.bind(this))}exec(e){let t,n;if(!(t=this.$cursor.range)||!(n=this.makeDOMFunc.call(null)))return;const{startContainer:s,startOffset:r}=t;n.props.src=e;const o=_(n);t.collapsed||t.deleteContents(),t.insertNode(o),this.$cursor.saveRange($.setCursor(s,r)),this.$cursor.saveCursoredElm()}});var ne;!function(){const t=document.querySelector("#json-container"),n=function(t={}){const n=[],s=new F(t),r={use:(e,...t)=>(n.push([e,...t]),r),mount(t){let r;if(o()||l("No Document Provides!"),e(t)){if(r=document.querySelector(t),!r)throw new a(`No such element: "${t}"`)}else r=t;return s.register(n),s.mount(r)}};return r}({autofocus:!1,placeholder:"请输入文字。"}).use(U,(()=>"#bold"),"active").use(K,(()=>"#italic"),"active").use(P,(()=>"#underline"),"active").use(q,(()=>"#strike-through"),"active").use(J,(()=>"#heading"),"active").use(G,(()=>"#paragraph"),"active").use(Y,(()=>"#ol"),"active").use(ee,(()=>"#ul"),"active").use(H,(()=>"#blockquote"),"active").use(X,(()=>"#align-left"),"active").use(z,(()=>"#align-center"),"active").use(Q,(()=>"#align-right"),"active").use(te,(function(e){const t=document.querySelector("#img"),n=document.querySelector("#img-input");t&&n&&(t.addEventListener("click",(()=>{n.click()}),!1),n.addEventListener("change",(t=>{const n=t.target.files;if(!n)return;let s,r;for(let t=0;t<n.length;t++){s=n[t];const o=new FileReader;o.onload=function(t){(r=t.target)&&e(String(r.result))},o.readAsDataURL(s)}}),!1))})).mount("#content");n.onRangeSaved((()=>{t&&(t.innerHTML=JSON.stringify(n.getJson()))}))}();
